# Vertical Navigation Migration

**Status:** Planning
**Created:** 2025-10-29
**Target:** Whispering v7.6.0+

## Problem Statement

The current Whispering app uses a topbar navigation layout that:

- Only appears on config routes (`/recordings`, `/transformations`, `/settings`)
- Is absent from the home page, causing inconsistent navigation
- Duplicates recording controls between topbar and home page content
- Creates navigation confusion for users
- Limits screen real estate for content on smaller displays

The topbar navigation may eventually be deprecated in favor of a more consistent vertical navigation approach.

## Proposed Solution

Implement a **vertical navigation layout** as a new route group that:

1. Provides consistent navigation across ALL routes (including home)
2. Consolidates recording controls in one location (vertical nav)
3. Removes duplicate selectors from home page content
4. Preserves existing topbar layout as "legacy" with minimal modifications
5. Allows gradual migration and eventual removal of topbar layout
6. Uses shadcn-svelte Sidebar component following existing patterns in `/packages/ui`
   - Based on [sidebar-07](https://www.shadcn-svelte.com/blocks/sidebar#sidebar-07) - collapses to icons
   - Consistent with project's shadcn-svelte usage

## Design Decisions

### Route Structure: Separate Route Groups

**Chosen approach:** Create new `verticalnav/` route group alongside existing `(config)/` route group.

**Rationale:**

- Minimal modification to existing files (topbar becomes legacy)
- Clean separation allows independent evolution
- Easy to delete legacy later by removing entire `(config)/` folder
- No conditional complexity in shared layout files
- Safe rollback if issues arise

### AppShell: Shared at Root

**Decision:** Keep `AppShell.svelte` at root level, shared by both layouts.

**Rationale:**

- AppShell handles app lifecycle (updates, migrations, permissions, shortcuts)
- These concerns are layout-agnostic
- Avoids duplication of critical initialization logic
- Single source of truth for global services

### Implementation: Copy and Modify

**Decision:** Copy `(config)/+layout.svelte` logic, create new sidebar UI from scratch.

**Rationale:**

- Preserves complex state management (recorder queries, mode switching)
- Reduces risk of missing edge cases
- Allows gradual UI transformation
- Keeps all conditional recording mode logic working

## Vertical Navigation Layout Design

### VerticalNav Sections (Top to Bottom)

1. **App Branding** (Header - no group label)
   - Whispering logo/name
   - Non-interactive, just branding

2. **Navigation** (Group - no group label)
   - Home
   - Recordings
   - Transformations
   - Settings

3. **Quick Settings** (Group label: "Quick Settings")
   - Device selector (Manual/VAD based on mode)
   - Compression selector
   - Transcription selector
   - Transformation selector

4. **Quick Transcription** (Group label: "Quick Transcription")
   - Recording action button (üéôÔ∏è / üëÇ / üé¨)
   - Recording mode selector dropdown
   - Cancel button (when recording)

5. **Footer Actions** (Footer - no group label)
   - Theme toggle (dark/light mode)
   - GitHub link
   - Minimize button (desktop only)

### Responsive Behavior

- **Desktop (‚â•768px)**: Full vertical nav visible, ~240px width
- **Tablet (640px-768px)**: Collapsible vertical nav
- **Mobile (<640px)**: Offcanvas drawer (slides in/out)

### Collapse States and Toggle Button

The vertical nav implements a **two-state system** using the built-in shadcn-svelte collapse behavior.

#### Initial Implementation: Expanded ‚Üî Icon-only

**Decision:** Start with the simpler two-state pattern. A third "completely hidden" state can be added later if users request it.

**Rationale:**

- Icon-only mode (~48px) already provides significant space savings
- Users maintain quick access to navigation and recording controls
- Simpler implementation, less state management
- Follows shadcn-svelte sidebar-07 pattern directly
- Mobile already has "hidden" state via offcanvas drawer

#### State Management (Initial)

```svelte
// No custom state needed - use built-in Sidebar.Trigger
<Sidebar.Provider>
	<Sidebar.Root collapsible="icon">
		<Sidebar.Header>
			<span>Whispering</span>
		</Sidebar.Header>
		<Sidebar.Content>
			<!-- Nav items -->
		</Sidebar.Content>
	</Sidebar.Root>

	<Sidebar.Inset>
		<header>
			<!-- Built-in toggle button -->
			<Sidebar.Trigger />
			<span>Page Title</span>
		</header>
		<main>{@render children()}</main>
	</Sidebar.Inset>
</Sidebar.Provider>
```

#### Two States

1. **Expanded** - Full vertical nav with labels (~240px)
2. **Icon-only** - Collapsed to icons (~48px)

Toggle via `<Sidebar.Trigger />` component in content header, or keyboard shortcut (`Cmd/Ctrl + B`).

#### Mobile Behavior

On mobile (`<640px`):

- Use `collapsible="offcanvas"` for drawer behavior
- Vertical nav hidden by default, slides in when opened
- Single toggle button in header
- Provides the "hidden" state that desktop may add later

### Home Page Changes

**Remove from home page content:**

- Duplicate recording selectors (device, compression, transcription, transformation)
- Recording mode toggle group (move to vertical nav)
- Scattered control buttons

**Keep on home page:**

- Large visual recording indicator/button (for discoverability)
- Transcription output display
- Audio player
- Help text and shortcuts

## Implementation Plan

### Phase 1: Create Vertical Navigation Layout

**Goal:** New vertical nav layout working alongside existing topbar layout.

**Important:** During Phases 1-2, we use `(app)/verticalnav/` (without parentheses) to avoid SvelteKit route conflicts with `(app)/(config)/`. Both route groups would match the same URLs, causing errors. In Phase 3, we'll move the vertical nav layout directly into `(app)/+layout.svelte` after removing `(config)/`.

**Note:** The main codebase now organizes all app routes under `(app)/` group. Our vertical nav will follow this pattern.

**Why no `(verticalnav)/` route group in final state?**

- After removing topbar, there's only ONE layout, so no need for route grouping
- Simpler structure: vertical nav lives directly in `(app)/+layout.svelte`
- Standard pattern: most apps have layout directly in route group without extra nesting
- Follows YAGNI principle: don't add grouping unless there's a real need

#### Temporary Layout Switching Links

**Purpose:** Allow easy switching between topbar and vertical nav layouts during development/testing.

**Implementation:**

Add a link to the bottom of the content on each home page:

1. **Topbar home page** (`(app)/(config)/+page.svelte`):

   ```svelte
   <!-- At bottom of page content -->
   <div class="mt-8 text-center">
   	<a
   		href="/verticalnav"
   		class="text-sm text-muted-foreground hover:underline"
   	>
   		Try the new vertical navigation layout
   	</a>
   </div>
   ```

2. **VerticalNav home page** (`(app)/verticalnav/+page.svelte`):
   ```svelte
   <!-- At bottom of page content -->
   <div class="mt-8 text-center">
   	<a href="/" class="text-sm text-muted-foreground hover:underline">
   		Return to classic topbar layout
   	</a>
   </div>
   ```

**Location:** Bottom of main content area, after transcription output and help text.

**Styling:**

- Small, subtle text (`text-sm text-muted-foreground`)
- Hover underline for affordance
- Center-aligned

**Removal:** Delete these links in Phase 3 when finalizing vertical nav as default (no need for switching after topbar is removed).

#### Step 1.1: Create Route Structure

```
apps/whispering/src/routes/
  (app)/
    verticalnav/              # WITHOUT parentheses (development)
      +layout.svelte          # Copy from (app)/(config)/+layout.svelte
      +layout/
        VerticalNav.svelte    # New component (created from scratch)
      +page.svelte            # Copy from (app)/+page.svelte
```

**Access via:**

- Topbar (existing): `http://localhost:5173/recordings`
- VerticalNav (new): `http://localhost:5173/verticalnav/recordings`

**Tasks:**

- [ ] Create `(app)/verticalnav/` directory (without parentheses on verticalnav)
- [ ] Copy `(app)/(config)/+layout.svelte` ‚Üí `(app)/verticalnav/+layout.svelte`
- [ ] Copy `(app)/+page.svelte` ‚Üí `(app)/verticalnav/+page.svelte`

#### Step 1.2: Install and Setup shadcn-svelte Sidebar

**Prerequisites:**

First, add the sidebar component to `/packages/ui`:

```bash
cd packages/ui
pnpm dlx shadcn-svelte@latest add https://shadcn-svelte.com/registry/default/ui/sidebar.json
```

This will add the necessary Sidebar primitives to `/packages/ui/src/sidebar/`.

**Tasks:**

- [ ] Install sidebar component in `/packages/ui`
- [ ] Export sidebar components from `/packages/ui/src/index.ts`
- [ ] Verify imports work in whispering app

#### Step 1.3: Create App VerticalNav Component

**File:** `apps/whispering/src/routes/(app)/verticalnav/+layout/VerticalNav.svelte`

Based on [sidebar-07](https://www.shadcn-svelte.com/blocks/sidebar#sidebar-07) pattern (collapses to icons).

**Props interface:**

```typescript
interface Props {
	getRecorderStateQuery: CreateQueryResult;
	getVadStateQuery: CreateQueryResult;
	isMobile: boolean;
}
```

**Structure using shadcn-svelte components:**

```svelte
<script lang="ts">
	import { page } from '$app/state';
	import * as Sidebar from '@repo/ui/sidebar';
	import { HomeIcon, ListIcon, LayersIcon, SettingsIcon } from '@lucide/svelte';

	let { getRecorderStateQuery, getVadStateQuery, isMobile }: Props = $props();

	// Navigation items array (similar to NavItems.svelte)
	const navItems = [
		{
			label: 'Home',
			icon: HomeIcon,
			href: '/',
		},
		{
			label: 'Recordings',
			icon: ListIcon,
			href: '/recordings',
		},
		{
			label: 'Transformations',
			icon: LayersIcon,
			href: '/transformations',
		},
		{
			label: 'Settings',
			icon: SettingsIcon,
			href: '/settings',
		},
	] as const;

	const isItemActive = (item: (typeof navItems)[number]) => {
		if (item.href === '/') {
			return page.url.pathname === '/';
		}
		return page.url.pathname.startsWith(item.href);
	};
</script>

<Sidebar.Root collapsible="icon">
	<Sidebar.Header>
		<div class="flex items-center px-2">
			<span class="font-bold text-lg">Whispering</span>
		</div>
	</Sidebar.Header>

	<Sidebar.Content>
		<!-- Section order: 1. Branding, 2. Navigation (no label), 3. Quick Settings, 4. Quick Transcription, 5. Footer -->

		<!-- Navigation group - no label -->
		<Sidebar.Group>
			<Sidebar.GroupContent>
				<Sidebar.Menu>
					{#each navItems as item}
						{@const Icon = item.icon}
						{@const isActive = isItemActive(item)}
						<Sidebar.MenuItem>
							<Sidebar.MenuButton href={item.href} {isActive}>
								<Icon />
								<span>{item.label}</span>
							</Sidebar.MenuButton>
						</Sidebar.MenuItem>
					{/each}
				</Sidebar.Menu>
			</Sidebar.GroupContent>
		</Sidebar.Group>

		<Sidebar.Group>
			<Sidebar.GroupLabel>Quick Settings</Sidebar.GroupLabel>
			<Sidebar.GroupContent>
				<!-- Device, Compression, Transcription, Transformation selectors -->
			</Sidebar.GroupContent>
		</Sidebar.Group>

		<Sidebar.Group>
			<Sidebar.GroupLabel>Quick Transcription</Sidebar.GroupLabel>
			<Sidebar.GroupContent>
				<!-- Recording action button, mode selector -->
			</Sidebar.GroupContent>
		</Sidebar.Group>
	</Sidebar.Content>

	<Sidebar.Footer>
		<!-- No group label in footer -->
		<Sidebar.Menu>
			{#each footerItems as item}
				{@const Icon = item.icon}
				<Sidebar.MenuItem>
					{#if item.type === 'anchor'}
						<Sidebar.MenuButton
							href={item.href}
							target={item.external ? '_blank' : undefined}
							rel={item.external ? 'noopener noreferrer' : undefined}
						>
							<Icon />
							<span>{item.label}</span>
						</Sidebar.MenuButton>
					{:else if item.type === 'button'}
						<Sidebar.MenuButton onclick={item.action}>
							<Icon />
							<span>{item.label}</span>
						</Sidebar.MenuButton>
					{:else if item.type === 'theme'}
						<Sidebar.MenuButton onclick={item.action}>
							<SunIcon
								class="h-4 w-4 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"
							/>
							<MoonIcon
								class="absolute h-4 w-4 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"
							/>
							<span>{item.label}</span>
						</Sidebar.MenuButton>
					{/if}
				</Sidebar.MenuItem>
			{/each}
		</Sidebar.Menu>
	</Sidebar.Footer>
</Sidebar.Root>
```

**Footer items array (similar to NavItems.svelte):**

```svelte
<script lang="ts">
	import { toggleMode } from 'mode-watcher';
	import { getCurrentWindow } from '@tauri-apps/api/window';
	import { LogicalSize } from '@tauri-apps/api/window';
	import { notificationLog } from '$lib/components/NotificationLog.svelte';
	import { LogsIcon } from '@lucide/svelte';

	const footerItems = [
		{
			label: 'Toggle dark mode',
			icon: SunIcon,
			type: 'theme' as const,
			action: toggleMode,
		},
		{
			label: 'View project on GitHub',
			icon: GithubIcon,
			href: 'https://github.com/epicenter-md/epicenter',
			type: 'anchor' as const,
			external: true,
		},
		...(window.__TAURI_INTERNALS__
			? ([
					{
						label: 'Minimize',
						icon: Minimize2Icon,
						type: 'button' as const,
						action: () => getCurrentWindow().setSize(new LogicalSize(72, 84)),
					},
				] as const)
			: []),
		{
			label: 'Notifications',
			icon: LogsIcon,
			type: 'button' as const,
			action: () => {
				notificationLog.isOpen = !notificationLog.isOpen;
			},
		},
	];
</script>
```

**Implementation Notes:**

- Use array-based navigation pattern similar to `NavItems.svelte` (lines 24-67)
- Define `navItems` array with label, icon, href
- Define `footerItems` array with label, icon, type (anchor/button/theme), action/href
- Use `{#each}` to iterate and render items dynamically
- Keep `isItemActive()` helper for active state logic
- This approach makes items easy to add/remove/reorder

**Tasks:**

- [ ] Create VerticalNav.svelte component
- [ ] Set `collapsible="icon"` on Sidebar.Root
- [ ] Implement header with branding
- [ ] Define `navItems` array (Home, Recordings, Transformations, Settings)
- [ ] Define `footerItems` array (Theme, GitHub, Minimize, Notifications)
- [ ] Import `notificationLog` from NotificationLog.svelte
- [ ] Render navigation items using `{#each navItems}`
- [ ] Implement active route highlighting with `isItemActive()` helper
- [ ] Add configuration selectors section (Quick Settings)
- [ ] Add recording controls section (Quick Transcription)
- [ ] Render footer items using `{#each footerItems}`
- [ ] Remove floating NotificationLog button from AppLayout.svelte
- [ ] Update dev tools positioning (TanStack bottom-right, Inspector top-right)
- [ ] Test collapse to icon functionality (via Sidebar.Trigger in layout)
- [ ] Style to match Whispering theme

#### Step 1.4: Migrate Recording Controls to VerticalNav

**Source logic:** `(app)/(config)/+layout.svelte` lines 46-149

**Strategy:** Extract recording controls into reusable components.

**New components:**

```
(app)/verticalnav/+layout/
  VerticalNav.svelte
  RecordingControls.svelte      # Action button + mode selector
  RecordingSelectors.svelte     # Device, compression, transcription, transformation
```

**Tasks:**

- [ ] Create RecordingControls.svelte
  - [ ] Manual mode: microphone button + mode dropdown
  - [ ] VAD mode: ear button + mode dropdown
  - [ ] Upload mode: mode dropdown only
  - [ ] Live mode: camera button + mode dropdown
- [ ] Create RecordingSelectors.svelte
  - [ ] Conditional device selector (Manual vs VAD)
  - [ ] Compression selector
  - [ ] Transcription selector
  - [ ] Transformation selector
  - [ ] Handle state-based visibility (hide during recording)
- [ ] Extract NavItems logic for vertical nav context
- [ ] Test all recording modes and state transitions

#### Step 1.5: Update VerticalNav Layout File

**File:** `(app)/verticalnav/+layout.svelte`

**Structure:**

```svelte
<script lang="ts">
  import VerticalNav from './+layout/VerticalNav.svelte';
  import * as Sidebar from '@repo/ui/sidebar';
  
  // Keep all state management from (app)/(config)/+layout.svelte
  const getRecorderStateQuery = createQuery(...);
  const getVadStateQuery = createQuery(...);
  const isMobile = new MediaQuery(...);
  
  let { children } = $props();
</script>

<Sidebar.Provider>
	<VerticalNav {getRecorderStateQuery} {getVadStateQuery} {isMobile} />

	<Sidebar.Inset>
		<header class="flex h-14 items-center gap-2 border-b px-4">
			<!-- Built-in toggle button -->
			<Sidebar.Trigger />
			<span class="text-lg font-semibold">Page Title</span>
		</header>

		<main class="flex-1 overflow-auto">
			{@render children()}
		</main>
	</Sidebar.Inset>
</Sidebar.Provider>
```

**Tasks:**

- [ ] Wrap in `Sidebar.Provider`
- [ ] Use built-in `<Sidebar.Trigger />` in content header
- [ ] Pass state queries as props to VerticalNav
- [ ] Use `Sidebar.Inset` for main content area
- [ ] Add proper overflow handling (prevent double scrollbars)
- [ ] Test layout on various screen sizes
- [ ] Test keyboard shortcut (Cmd/Ctrl + B)

#### Step 1.6: Update VerticalNav Home Page

**File:** `(app)/verticalnav/+page.svelte`

**Remove:**

- Recording mode toggle group (now in vertical nav)
- Device/compression/transcription/transformation selectors (now in vertical nav)
- Inline recording controls

**Keep:**

- Large visual recording indicator
- Transcription output display
- Audio player
- Help text and shortcuts
- NavItems links (now redundant with vertical nav, consider removing)

**Tasks:**

- [ ] Remove duplicate recording selectors
- [ ] Remove recording mode toggle group
- [ ] Simplify layout to focus on output
- [ ] Keep large visual microphone/indicator for UX
- [ ] Update help text to reference vertical nav controls
- [ ] Test responsive behavior

### Phase 2: Add Page Routes to VerticalNav Group

**Goal:** Copy/link all existing pages to work with vertical nav layout.

#### Step 2.1: Recordings Page

```
(app)/verticalnav/recordings/
  +page.svelte                           # Import from (app)/(config)
  row-actions/
    EditRecordingModal.svelte            # Symlink or import
    RecordingRowActions.svelte           # Symlink or import
    TransformationPicker.svelte          # Symlink or import
    ViewTransformationRunsDialog.svelte  # Symlink or import
  LatestTransformationRunOutputByRecordingId.svelte
  RenderAudioUrl.svelte
```

**Strategy:** Re-export components from (app)/(config) to avoid duplication.

**Tasks:**

- [ ] Create `(app)/verticalnav/recordings/+page.svelte`
- [ ] Import and re-export from `(app)/(config)/recordings/+page.svelte`
- [ ] Test functionality with vertical nav layout
- [ ] Verify row actions and dialogs work correctly

#### Step 2.2: Transformations Page

```
(app)/verticalnav/transformations/
  +page.svelte
  new/
    +page.svelte
  CreateTransformationButton.svelte
  EditTransformationModal.svelte
  MarkTransformationActiveButton.svelte
  TransformationRowActions.svelte
```

**Tasks:**

- [ ] Create `(app)/verticalnav/transformations/+page.svelte`
- [ ] Import and re-export from `(app)/(config)/transformations/+page.svelte`
- [ ] Copy `new/+page.svelte` or import
- [ ] Test transformation editor with vertical nav layout
- [ ] Verify all modals and actions work

#### Step 2.3: Settings Pages

```
(app)/verticalnav/settings/
  +layout.svelte                    # May need modification
  +page.svelte
  SidebarNav.svelte                 # Settings sub-navigation (no collision with VerticalNav)
  analytics/+page.svelte
  api-keys/+page.svelte
  recording/+page.svelte
  shortcuts/
    +layout.svelte
    +page.svelte
    global/+page.svelte
    local/+page.svelte
  sound/+page.svelte
  transcription/+page.svelte
```

**Note:** Settings already has its own `SidebarNav.svelte` for sub-navigation (no name collision with VerticalNav).

**Tasks:**

- [ ] Create `(app)/verticalnav/settings/+layout.svelte`
- [ ] Import pages from `(app)/(config)/settings/`
- [ ] Ensure settings sidebar works with app vertical nav
- [ ] Test nested navigation
- [ ] Verify all settings pages render correctly

#### Step 2.4: Special Pages

```
(app)/verticalnav/
  desktop-app/+page.svelte
  global-shortcut/+page.svelte
  install-ffmpeg/+page.svelte
  macos-enable-accessibility/+page.svelte
```

**Tasks:**

- [ ] Copy or import special pages
- [ ] Test onboarding flows with vertical nav
- [ ] Verify desktop-specific pages work

### Phase 3: Finalize VerticalNav as Default

**Goal:** Make vertical nav the default layout and remove topbar.

#### Step 3.1: Move VerticalNav to Main App Layout

**Strategy:** Move vertical nav directly into `(app)/+layout.svelte` - no need for a separate route group since there's only one layout.

**Tasks:**

- [ ] Delete `(app)/(config)/` folder entirely
- [ ] Move `(app)/verticalnav/+layout.svelte` content into `(app)/+layout.svelte`
- [ ] Move `(app)/verticalnav/_components/` to `(app)/_components/` (or keep inline if small)
- [ ] Move all page routes from `(app)/verticalnav/*` to `(app)/*`
  - `(app)/verticalnav/recordings/` ‚Üí `(app)/recordings/`
  - `(app)/verticalnav/transformations/` ‚Üí `(app)/transformations/`
  - `(app)/verticalnav/settings/` ‚Üí `(app)/settings/`
  - etc.
- [ ] Update any hardcoded links that used `/verticalnav/` prefix (should be none if using relative links)
- [ ] Test all routes work at root level (e.g., `/recordings`, `/settings`)
- [ ] Verify VerticalNav renders correctly in main app layout

**Final structure:**

```
routes/
  (app)/
    +layout.svelte           # Now includes VerticalNav
    _components/
      AppLayout.svelte       # Existing app lifecycle wrapper
      VerticalNav.svelte     # Vertical nav component
      RecordingControls.svelte
      RecordingSelectors.svelte
    _layout-utils/           # Existing utilities
    recordings/
    transformations/
    settings/
    +page.svelte
```

#### Step 3.2: Optional - Add UI Preference Setting (Not Recommended)

**Skip this step.** Since we're removing topbar entirely, there's no need for a layout preference setting. This was only considered if supporting both layouts temporarily, which adds unnecessary complexity.

#### Step 3.3: Update Release Notes

**Document the change for users:**

**Tasks:**

- [ ] Update CHANGELOG with vertical nav migration
- [ ] Create release notes highlighting new layout
- [ ] Document any breaking changes
- [ ] Add screenshots of new vertical nav
- [ ] Mention topbar removal

### Phase 4: Testing and Refinement

**Goal:** Ensure vertical nav layout is production-ready.

#### Step 4.1: Functional Testing

**Test cases:**

- [ ] All recording modes work (manual, VAD, upload, live)
- [ ] Recording state transitions (idle ‚Üí recording ‚Üí stopped)
- [ ] Selectors open and close properly
- [ ] Navigation works on all pages
- [ ] Dialogs and modals render correctly
- [ ] Theme switching works
- [ ] Minimize works (desktop)
- [ ] Permissions flows work
- [ ] Shortcuts work with sidebar visible
- [ ] Update checks and notifications appear

#### Step 4.2: Responsive Testing

**Breakpoints to test:**

- [ ] Large desktop (‚â•1280px)
- [ ] Desktop (1024px-1280px)
- [ ] Tablet landscape (768px-1024px)
- [ ] Tablet portrait (640px-768px)
- [ ] Mobile (320px-640px)
- [ ] Tiny mobile (<320px)

**Issues to verify:**

- [ ] No horizontal scrollbars
- [ ] Content doesn't overflow
- [ ] VerticalNav collapses appropriately
- [ ] Touch targets are adequate (44px minimum)
- [ ] Text remains readable
- [ ] No layout shifts

#### Step 4.3: Performance Testing

**Metrics:**

- [ ] Initial load time
- [ ] Navigation between pages
- [ ] Recording start latency
- [ ] Memory usage
- [ ] VerticalNav collapse/expand smoothness

#### Step 4.4: Accessibility Testing

**Requirements:**

- [ ] Keyboard navigation works
- [ ] Focus management is correct
- [ ] ARIA labels present
- [ ] Screen reader compatibility
- [ ] Color contrast meets WCAG AA
- [ ] No keyboard traps

### Phase 5: Documentation and Release

**Goal:** Document changes and release to users.

#### Step 5.1: Update Documentation

**Files to update:**

- [ ] `apps/whispering/README.md` - Add vertical nav layout info
- [ ] Release notes - Document new vertical nav layout
- [ ] User guide - Update screenshots and instructions
- [ ] Developer docs - Document route structure

#### Step 5.2: Analytics Integration

**Events to track:**

- [ ] `vertical_nav_layout_enabled` - User switches to vertical nav
- [ ] `vertical_nav_layout_disabled` - User switches back to topbar
- [ ] `vertical_nav_collapsed` - User collapses vertical nav
- [ ] `vertical_nav_expanded` - User expands vertical nav
- [ ] Usage by page/route

**Tasks:**

- [ ] Add analytics events
- [ ] Test event firing
- [ ] Verify PostHog dashboard

#### Step 5.3: Release Strategy

**Simplified rollout (single layout approach):**

1. **Beta release** (v7.6.0-beta.1)
   - VerticalNav replaces topbar completely
   - Gather feedback from beta testers
   - Fix critical issues

2. **Stable release** (v7.6.0)
   - VerticalNav is the default and only layout
   - `(config)/` routes removed
   - Release notes document the change
   - Provide support for user questions

**Tasks:**

- [ ] Create beta build with vertical nav
- [ ] Announce on Discord/GitHub
- [ ] Collect feedback
- [ ] Fix critical bugs
- [ ] Release stable version
- [ ] Monitor for issues

## Technical Considerations

### Overflow and Scrolling

**Challenge:** Prevent double scrollbars (body + vertical nav + content).

**Solution:**

```css
html,
body {
	height: 100vh;
	overflow: hidden;
}

.app-with-vertical-nav {
	display: flex;
	height: 100vh;
}

.vertical-nav {
	overflow-y: auto;
	flex-shrink: 0;
}

.main-content {
	overflow-y: auto;
	flex: 1;
	min-width: 0;
}
```

### State Management

**Challenge:** Recording controls need access to recorder state, settings, and commands.

**Solution:** Pass state down from parent layout as props, or use existing context/stores.

### Mobile Considerations

**Options for mobile vertical nav:**

1. **Slide-out drawer** - Activated by hamburger button
2. **Bottom navigation** - Recording controls + nav icons
3. **Full-screen overlay** - Tappable sections

**Recommendation:** Start with slide-out drawer (most familiar pattern).

### Recording Control Placement

**Decision:** Keep recording controls at top of vertical nav (always visible).

**Rationale:**

- Primary action should be immediately accessible
- State indicators need to be visible at all times
- Users expect recording controls to be prominent

### Settings Sidebar Conflict

**Issue:** Settings already has `SidebarNav.svelte` for subsection navigation.

**Solution:**

- New app vertical nav named `VerticalNav.svelte`
- Keep existing settings `SidebarNav.svelte` as is (no changes to existing file, no name collision)
- Both work together (app VerticalNav + settings SidebarNav sub-navigation)

### Notification History Integration

**Decision:** Move notification history button from floating (bottom-right) to vertical nav footer (bottom-most position).

**Current Implementation:**

The app already has `NotificationLog.svelte`:

- Floating button at bottom-right with `LogsIcon`
- Opens popover with scrollable log of past notifications
- Shows title, description, variant (success/error/warning/info/loading)
- Currently rendered in `AppLayout.svelte`

**Changes:**

1. **Add to footer items array** (last position = bottom-most):

   ```svelte
   {
     label: 'Notifications',
     icon: LogsIcon,
     type: 'button' as const,
     action: () => { notificationLog.isOpen = !notificationLog.isOpen },
   }
   ```

2. **Remove floating button** from `AppLayout.svelte` (or conditionally hide when vertical nav is active)

3. **Keep popover in root layout** so it's always accessible

**Benefits:**

- Frees up bottom-right corner for dev tools
- More discoverable (always visible in nav, not floating)
- Consistent with other app controls (theme, GitHub, minimize)
- Bottom-most position = most accessible

**Note:** No unread count badge needed - keep it simple.

### Development Tools Positioning

**Decision:** Reposition dev tools to top-right and bottom-right corners now that vertical nav uses left side.

**Rationale:**

- Top-right corner is now free (topbar removed)
- Bottom-right freed up by moving notifications to vertical nav
- Clear separation: production UI (left) vs dev tools (right edge)

**Implementation:**

```svelte
<!-- Root +layout.svelte -->

<!-- TanStack Query Devtools: Bottom Right -->
<SvelteQueryDevtools client={queryClient} buttonPosition="bottom-right" />

<style>
	/* Svelte Inspector: Top Right */
	:global(#svelte-inspector-host button) {
		top: 16px !important;
		right: 16px !important;
		bottom: auto !important;
		left: auto !important;
		transform: none !important;
	}
</style>
```

**Final Layout (Development Mode):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ  [Svelte Inspector] üîç          ‚îÇ ‚Üê Top right (dev)
‚îÇ VerticalNav  ‚îÇ                                 ‚îÇ
‚îÇ              ‚îÇ         Content                 ‚îÇ
‚îÇ              ‚îÇ                                 ‚îÇ
‚îÇ [Theme] üåô   ‚îÇ                                 ‚îÇ
‚îÇ [GitHub] üêô  ‚îÇ                                 ‚îÇ
‚îÇ [Notif] üîî   ‚îÇ                [TanStack] üîß    ‚îÇ ‚Üê Bottom right (dev)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Corner Usage:**

- **Top-left:** Vertical nav header (branding)
- **Top-right:** Svelte Inspector (dev only)
- **Bottom-left:** Notifications button (in vertical nav footer)
- **Bottom-right:** TanStack Query Devtools (dev only)

### Button Component Strategy

**Decision:** Do NOT use `WhisperingButton` component in VerticalNav implementation.

**Context:**

`WhisperingButton` (`apps/whispering/src/lib/components/WhisperingButton.svelte`) is a Button + Tooltip wrapper created for the topbar navigation:

```svelte
<WhisperingButton tooltipContent="Go home" href="/">
	<span>whispering</span>
</WhisperingButton>
```

This component exists because the topbar has extremely constrained horizontal space, requiring tooltips to explain icon-only buttons.

**Why NOT to use it in VerticalNav:**

1. **Context Difference:**
   - **Topbar:** ~800px horizontal space shared by branding, selectors, controls, navigation ‚Üí tooltips necessary
   - **VerticalNav Expanded:** ~240px vertical space ‚Üí plenty of room for visible text labels
   - **VerticalNav Icon-only:** ~48px ‚Üí shadcn-svelte `Sidebar.MenuButton` has built-in tooltip behavior

2. **Built-in Tooltip Support:**
   - `<Sidebar.MenuButton>` automatically shows tooltips when sidebar is collapsed to icon-only mode
   - The library handles this pattern natively: labels when expanded, tooltips when collapsed
   - No need for custom wrapper components

3. **Semantic Difference:**
   - `WhisperingButton` treats labels as secondary (hidden in tooltips)
   - VerticalNav should have **visible labels as primary UI**, not tooltips
   - Icons are supplementary, not the primary interface

4. **Accessibility & Discoverability:**
   - Visible labels are more accessible than icon-only + hover tooltips
   - New users can discover features by reading labels
   - Tooltips should be progressive enhancement, not the only affordance

**What to Use Instead:**

**Navigation Items:**

```svelte
<Sidebar.MenuButton href="/recordings">
	<ListIcon />
	<span>Recordings</span>
	<!-- Visible when expanded, tooltip when collapsed -->
</Sidebar.MenuButton>
```

**Action Buttons (Recording Controls):**

```svelte
<Button onclick={commandCallbacks.toggleManualRecording}>
	{recorderStateToIcons[state]}
	<span>Start Recording</span>
	<!-- Visible label -->
</Button>
```

**Footer Actions:**

```svelte
<Sidebar.MenuButton onclick={toggleTheme}>
	<SunIcon />
	<span>Toggle theme</span>
</Sidebar.MenuButton>
```

**Summary:**

- Keep `WhisperingButton` for topbar (legacy, space-constrained UI)
- Use standard shadcn-svelte Sidebar components for VerticalNav
- Leverage built-in tooltip behavior instead of custom wrappers
- Prioritize visible labels over icon-only + tooltips

### Active Route Highlighting

**Requirement:** Navigation items must visually indicate which page is currently active.

**Implementation:**

Use SvelteKit's `$page` store to determine active routes:

```svelte
<script lang="ts">
	import { page } from '$app/stores';
</script>

<Sidebar.MenuButton href="/" isActive={$page.url.pathname === '/'}>
	<HomeIcon />
	<span>Home</span>
</Sidebar.MenuButton>

<Sidebar.MenuButton
	href="/recordings"
	isActive={$page.url.pathname.startsWith('/recordings')}
>
	<ListIcon />
	<span>Recordings</span>
</Sidebar.MenuButton>
```

**Logic:**

- **Home:** Exact match `pathname === '/'`
- **Recordings, Transformations, Settings:** Prefix match `pathname.startsWith('/recordings')` to handle sub-routes
  - Example: `/recordings`, `/recordings/123`, `/recordings/edit` all highlight "Recordings"
  - Example: `/settings`, `/settings/api-keys`, `/settings/shortcuts/global` all highlight "Settings"

**Styling:**

The `isActive` prop on `Sidebar.MenuButton` will apply shadcn-svelte's built-in active styles (typically background color change, accent border, or font weight).

**Note:** Verify that shadcn-svelte Sidebar components support `isActive` prop. If not, use `data-active` attribute or custom class:

```svelte
<Sidebar.MenuButton
  href="/recordings"
  data-active={$page.url.pathname.startsWith('/recordings')}
  class={cn($page.url.pathname.startsWith('/recordings') && 'bg-accent')}
>
```

## Success Metrics

### Adoption Metrics

- % of users who enable vertical nav layout
- % of users who switch back to topbar
- Time to first recording with vertical nav
- User feedback sentiment

### Performance Metrics

- Page load time (no regression)
- Navigation speed (no regression)
- Memory usage (no significant increase)

### Bug Metrics

- Number of vertical nav-specific bugs reported
- Time to resolution
- Regression rate

## Risks and Mitigations

### Risk 1: User Confusion During Transition

**Mitigation:**

- Clear migration prompt with preview
- In-app help/tutorial for vertical nav
- Allow easy switching back to topbar
- Announce change in release notes

### Risk 2: Mobile Layout Challenges

**Mitigation:**

- Extensive testing on various devices
- Fallback to topbar on very small screens (<320px)
- Progressive enhancement approach

### Risk 3: Breaking Existing Workflows

**Mitigation:**

- Keep topbar available during transition
- Gather user feedback early
- Iterate based on usage patterns

### Risk 4: Increased Maintenance Burden

**Mitigation:**

- Plan for quick deprecation of topbar
- Set clear timeline for removal
- Minimize conditional logic

## Open Questions

1. **Mobile layout:** Slide-out drawer, bottom nav, or hybrid?
2. **VerticalNav width:** Fixed 240px or user-resizable?
3. **Collapse behavior:** Remember state or reset on navigation?
4. **Recording indicator:** Keep large visual on home page or vertical nav-only?
5. **Settings sub-nav:** Keep horizontal tabs or integrate into vertical nav tree?

## Future Enhancements

### Completely Hidden VerticalNav State

**Status:** Not included in initial implementation. Add if users request it.

**Rationale for deferring:**

- Icon-only mode (~48px) already provides significant space savings
- Difference between 48px and 0px is marginal on most displays
- Users maintain quick access to navigation in icon mode
- Simpler initial implementation reduces risk
- Can validate need with actual usage data

**Implementation pattern (if added later):**

```svelte
<script lang="ts">
	let verticalNavVisible = $state(true); // false = completely hidden

	function toggleHidden() {
		verticalNavVisible = !verticalNavVisible;
	}
</script>

<Sidebar.Provider>
	{#if verticalNavVisible}
		<Sidebar.Root collapsible="icon">
			<!-- content -->
		</Sidebar.Root>
	{/if}

	<Sidebar.Inset>
		<header>
			{#if verticalNavVisible}
				<Sidebar.Trigger /> <!-- Built-in collapse toggle -->
			{/if}
			<button onclick={toggleHidden}>
				<Menu />
				<!-- Hide/show toggle -->
			</button>
		</header>
	</Sidebar.Inset>
</Sidebar.Provider>
```

**Features when implemented:**

- Third state: Completely hidden vertical nav
- Separate toggle button for hide/show
- Keyboard shortcut: `Cmd/Ctrl + Shift + B` for super-hide
- User preference saved in settings
- Focus mode for presentations/recordings

**Usage tracking:**

- Monitor collapse/expand usage in analytics
- Survey users about need for complete hiding
- Implement if >20% of users request it

### App-Level Header (Gmail-style)

**Status:** Not included in initial implementation. Add if unified header is desired.

**Current Implementation (sidebar-07 pattern):**

- Each page has its own header inside `Sidebar.Inset`
- Header contains: `Sidebar.Trigger` + breadcrumbs/page title
- Header is part of page content, scrolls with content

**Proposed Enhancement (Gmail-style):**

- Single app-level header above vertical nav and content
- Header spans full width (vertical nav + content area)
- Header contains: branding + search + toggle + user menu
- Header is sticky/fixed at top, always visible

**Visual comparison:**

```
Current (sidebar-07):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ [‚ò∞] Breadcrumb       ‚îÇ ‚Üê Per-page header
‚îÇ VerticalNav  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              ‚îÇ                      ‚îÇ
‚îÇ              ‚îÇ  Page Content        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Proposed (Gmail-style):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Logo [Search] [‚ò∞] [User]      ‚îÇ ‚Üê App-level header
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              ‚îÇ                 ‚îÇ
‚îÇ VerticalNav  ‚îÇ  Page Content   ‚îÇ
‚îÇ              ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Implementation pattern:**

```svelte
<Sidebar.Provider>
	<!-- App-level header -->
	<header class="sticky top-0 z-50 flex h-14 items-center gap-4 border-b px-4">
		<span class="font-bold">Whispering</span>
		<input type="search" placeholder="Search..." class="flex-1 max-w-md" />
		<Sidebar.Trigger />
		<UserMenu />
	</header>

	<div class="flex flex-1">
		<VerticalNav />
		<Sidebar.Inset>
			<!-- No header here, content starts immediately -->
			<main class="flex-1 p-4">
				{@render children()}
			</main>
		</Sidebar.Inset>
	</div>
</Sidebar.Provider>
```

**Benefits:**

- Consistent branding always visible
- Global search accessible from anywhere
- Single toggle button location
- User menu always accessible
- Cleaner page content (no repeated header elements)

**Trade-offs:**

- Less flexibility per page (can't customize header easily)
- Header takes vertical space even when not needed
- Deviates from shadcn-svelte patterns (less maintainable)

**When to implement:**

- After initial release is stable
- If users request global search
- If branding visibility is important
- See sidebar-16 example for reference pattern

**Reference:** [sidebar-16](https://www.shadcn-svelte.com/blocks/sidebar#sidebar-16) shows a sticky site header pattern.

### Other Enhancements

- User-resizable vertical nav width
- Drag-and-drop reordering of nav items
- Collapsible sections in vertical nav
- Pinned/favorited transformations in vertical nav
- Quick recording history in vertical nav
- Mini-player in vertical nav for last recording
- Global command palette (Cmd+K search)

## References

- Current topbar implementation: `apps/whispering/src/routes/(app)/(config)/+layout.svelte`
- AppLayout implementation: `apps/whispering/src/routes/(app)/_components/AppLayout.svelte`
- NavItems component: `apps/whispering/src/lib/components/NavItems.svelte`
- Recording controls: Lines 46-149 in `(app)/(config)/+layout.svelte`
